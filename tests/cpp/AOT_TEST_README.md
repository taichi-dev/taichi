# AOT Unit Tests Programming Guide

An AOT test is usually composed of:
1. A python script that compiles the Kernels and serialize into file.
2. A C++ test that loads the file then perform execution.

AOT test writer will have to configure your test case in `cpptests.yaml`,
the format of which follows:

```yaml
- name: Descriptive name for the binary (not affecting actual test execution)
  binary: path/to/compiled/gtest_binary
  tests:
  - test: GTestModule.GTestCaseName
    script: path/to/python_scripts.py
    args: --arg1 --arg2
    markers: [marker1, marker2]
  - ...
```

`tests.test` is mandatory.
`tests.markers` is used for test case selection (`-k` option of `run_tests.py`), and is optional.
`tests.script` and `tests.args` are the script to run before executing the C++ test, they are also optional.

For example:

```yaml
- name: C++ Tests
  binary: ../../build/taichi_cpp_tests
  tests:
  - test: LlvmAotTest.CpuKernel
    script: aot/python_scripts/kernel_aot_test1.py
    args: --arch=cpu
  - test: LlvmAotTest.CudaKernel
    script: aot/python_scripts/kernel_aot_test1.py
    args: --arch=cuda

- name: C-API Tests
  binary: ../../build/taichi_c_api_tests
  tests:
  - test: CapiTest.Float16Fill
    script: aot/python_scripts/numerical_aot_test_.py
    args: --arch=vulkan
    markers: [sm70]
```

The temporary directory where serialized cache file stays will be generated by test case runner. Both python program and C++ tests receives this directory path via environment variable `TAICHI_AOT_FOLDER_PATH`.

For each AOT test, runner will first run the python program specified by `tests.script`, with `tests.args` as its arguments, followed by execution of the corresponding C++ test named by `tests.test` (`tests.args` does not apply to C++ test binary).
