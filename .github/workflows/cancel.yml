name: Cancel
on:
  workflow_run:
    workflows: ["Build and Test"]
    branches-ignore: [master]
    types:
      - requested

jobs:
  cancel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          RUN_ID=$(gh run list -w "Build and Test"|awk -F'\t' '{if ($5 == "${{ github.ref_name }}") {print $7;exit}}')
          if [ -z "$RUN_ID" ]; then
            echo "No run to cancel"
          else
            echo "Cancelling run $RUN_ID"
            gh run cancel $RUN_ID || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
